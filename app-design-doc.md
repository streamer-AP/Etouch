# 智能设备控制APP设计文档

## 一、项目概述

### 1.1 产品定位
本产品是一款智能硬件控制应用，通过移动端APP实现与智能设备的连接和控制，提供虚拟角色互动、剧情体验、音频联动等多维度沉浸式体验。

### 1.2 目标用户
- 智能硬件设备用户
- 追求个性化互动体验的用户群体
- 对虚拟角色互动感兴趣的用户

### 1.3 核心价值
- **多端同步**：实现APP与硬件设备的实时同步控制
- **沉浸体验**：通过虚拟角色、剧情、音频等多维度提供沉浸式体验
- **个性定制**：支持用户自定义模式和内容导入

## 二、功能架构

### 2.1 功能优先级划分

#### P0 核心功能（MVP版本）
1. 音频播放及设备联动
2. 音频导入、解析及设备联动
3. 基于手机播放音频的设备联动
4. 交互剧情展示及设备联动
5. 设备自由控制、预设模式控制

#### P1 重要功能
1. 虚拟人物交互展示
2. 用户账号注册及个人信息管理

#### P2 扩展功能（预留架构）
1. 日程提醒
2. 纪念日记录
3. 生理周期记录
4. 商城功能

### 2.2 系统架构

```
┌─────────────────────────────────────┐
│          前端展示层                   │
│  ┌──────┬──────┬──────┬──────┐    │
│  │角色  │沉浸  │控制  │个人  │    │
│  │展示  │体验  │界面  │中心  │    │
│  └──────┴──────┴──────┴──────┘    │
├─────────────────────────────────────┤
│          业务逻辑层                   │
│  ┌──────────────┬──────────────┐   │
│  │  设备管理    │  内容管理     │   │
│  ├──────────────┼──────────────┤   │
│  │  音频处理    │  用户管理     │   │
│  └──────────────┴──────────────┘   │
├─────────────────────────────────────┤
│          数据层                      │
│  ┌──────────────┬──────────────┐   │
│  │  本地存储    │  云端存储     │   │
│  └──────────────┴──────────────┘   │
├─────────────────────────────────────┤
│          硬件通信层                   │
│  ┌──────────────────────────────┐   │
│  │     蓝牙BLE协议栈            │   │
│  └──────────────────────────────┘   │
└─────────────────────────────────────┘
```

## 三、详细功能设计

### 3.1 全局导航栏

#### 3.1.1 导航结构
- **位置**：底部固定导航栏
- **组件**：4个页面切换按钮 + 1个中心设备按钮

#### 3.1.2 设备按钮状态机

```
状态流转图：
未注册 ──注册──> 已注册未连接 ──连接──> 已连接
   ↑                  ↓                    ↓
   └────注销──────────┴────断开────────────┘
```

**状态详情：**

| 状态 | 图标显示 | 点击行为 | 附加信息 |
|------|---------|---------|----------|
| 未注册无设备 | 加号图标 | 弹出蓝牙配对窗口 | - |
| 已注册未连接 | 灰色设备图标 | 弹出设备列表 | 显示已注册设备 |
| 已注册已连接 | 彩色设备图标 | 弹出设备列表 | 显示震动状态动效、电量 |

#### 3.1.3 设备列表弹窗
- **单设备模式**：直接显示设备详情卡片
- **多设备模式**：
  - 设备列表展示（图标、名称、电量、连接状态）
  - 支持设备切换
  - 添加新设备入口
  - 点击单个设备展开详情卡片

#### 3.1.4 页面切换
- **交互方式**：
  - 底部Tab点击切换
  - 左右滑动手势切换
- **视觉反馈**：当前页面图标高亮显示

### 3.2 角色展示页（主界面）

#### 3.2.1 虚拟角色系统

**Live2D模型管理：**
- 模型加载与渲染
- 多模型切换（左右滑动/按钮切换）
- 交互区域定义与响应

**交互逻辑状态机：**

```javascript
InteractionStates = {
  "未注册": {
    zones: [
      {id: "zone1", action: "提示注册"},
      {id: "zone2", action: "基础互动"}
    ]
  },
  "已注册未连接": {
    zones: [
      {id: "zone1", action: "提示连接"},
      {id: "zone2", action: "角色对话1"},
      {id: "zone3", action: "角色动作1"}
    ]
  },
  "已连接": {
    zones: [
      {id: "zone1", action: "设备控制触发"},
      {id: "zone2", action: "角色对话2"},
      {id: "zone3", action: "角色动作2"}
    ]
  },
  "已完成剧情": {
    zones: [
      {id: "zone1", action: "设备控制触发"},
      {id: "zone2", action: "角色对话2"},
      {id: "zone3", action: "角色动作2"},
      {id: "zone4", action: "解锁内容"}
    ]
  }
}
```

#### 3.2.2 设备状态显示
- **未注册**：显示"请连接设备开始体验"按钮
- **已注册**：
  - 设备图标（亮/暗表示连接状态）
  - 电量显示
  - 信号强度指示器

### 3.3 沉浸体验页

#### 3.3.1 页面布局
采用卡片式布局，支持左右滑动切换模块：

```
┌──────────────────────────────────┐
│         沉浸体验页               │
├──────┬──────┬──────┬──────────┤
│剧情  │音频  │导入  │实时捕捉  │
│演出  │体验  │解析  │        │
└──────┴──────┴──────┴──────────┘
```

#### 3.3.2 剧情演出模块

**功能流程：**
1. 剧情列表展示（解锁/未解锁状态）
2. 剧情加载（Loading UI）
3. L2D动画播放
4. 交互节点响应
5. 设备联动控制
6. 完成状态记录

**数据结构：**
```json
{
  "episode_id": "ep_001",
  "title": "剧情标题",
  "status": "locked/unlocked/completed",
  "animations": [...],
  "interactions": [...],
  "device_controls": [...]
}
```

#### 3.3.3 音频体验模块

**播放器界面：**
- 音频波形可视化
- 播放控制（播放/暂停、进度条、音量）
- 设备震动强度实时显示
- 预设震动模式选择

#### 3.3.4 音频导入解析模块

**支持格式：**
- 音频：MP3, WAV, AAC, M4A
- 视频：MP4, MOV（提取音频轨道）

**解析流程：**
1. 文件选择/拖拽导入
2. 音频特征提取（FFT分析）
3. 震动模式生成算法
4. 结果预览与调整
5. 保存至本地/云端

#### 3.3.5 实时音频捕捉模块

**技术实现：**
- 系统音频捕获权限申请
- 实时FFT频谱分析
- 特征提取（节奏、音量、频率分布）
- 设备控制映射算法

### 3.4 控制界面

#### 3.4.1 设备控制卡片

每个设备卡片包含：
- 设备名称（可编辑）
- 双通道独立控制
  - 开关切换
  - 强度滑块（0-100级）
- 预设模式快捷按钮

#### 3.4.2 组合控制编辑器

**时间轴编辑器：**
- 可调节时长（0-300秒）
- 多设备轨道
- 拖拽式操作
- 关键帧编辑
- 实时预览

**参数控制：**
- 震动强度曲线
- 频率变化
- 延迟设置

### 3.5 个人中心

#### 3.5.1 账户管理
- 头像系统（预设头像库/自定义上传）
- 账户信息（昵称、ID、绑定信息）
- 登录方式（手机号/邮箱/第三方）

#### 3.5.2 设置选项
- 设备管理
- 隐私设置
- 通知管理
- 缓存清理
- 关于我们

#### 3.5.3 其他功能
- 用户反馈入口
- 使用帮助
- 服务协议与隐私政策
- 商城链接（预留）

## 四、技术规范

### 4.1 客户端技术栈

**iOS端：**
- 开发语言：Swift 5.0+
- 最低支持：iOS 13.0
- 框架：UIKit/SwiftUI

**Android端：**
- 开发语言：Kotlin
- 最低支持：Android 6.0 (API 23)
- 框架：Jetpack Compose

**跨平台方案（备选）：**
- Flutter 3.0+
- React Native

### 4.2 蓝牙通信协议

**BLE规范：**
- 蓝牙版本：BLE 5.0
- 服务UUID定义
- 特征值定义
- 数据包格式

**通信协议：**
```
帧格式：
┌──────┬──────┬──────┬──────┬──────┬──────┐
│ 头部 │ 命令 │ 长度 │ 数据 │ 校验 │ 尾部 │
│ 2B   │ 1B   │ 2B   │ nB   │ 2B   │ 2B   │
└──────┴──────┴──────┴──────┴──────┴──────┘
```

### 4.3 音频处理

**音频分析库：**
- iOS：AVAudioEngine, Accelerate Framework
- Android：AudioRecord, TarsosDSP

**关键算法：**
- FFT快速傅里叶变换
- 节拍检测算法
- 包络跟踪
- 频段能量分析

### 4.4 数据存储

**本地存储：**
- 用户偏好：SharedPreferences/UserDefaults
- 音频文件：应用沙盒目录
- 缓存数据：LRU缓存策略

**云端同步：**
- 用户数据备份
- 剧情进度同步
- 自定义模式共享

## 五、UI/UX设计指南

### 5.1 设计原则
- **简洁直观**：降低学习成本
- **沉浸体验**：减少干扰元素
- **流畅动画**：60fps目标帧率
- **响应迅速**：操作反馈<100ms

### 5.2 视觉规范
- **主题色**：可定制主题系统
- **字体规范**：系统默认字体
- **图标风格**：线性图标为主
- **动效规范**：统一缓动函数

### 5.3 交互规范
- **手势操作**：支持常见手势
- **触觉反馈**：关键操作振动提示
- **loading状态**：统一加载动画
- **错误处理**：友好的错误提示

## 六、性能要求

### 6.1 性能指标
- 应用启动时间：< 3秒
- 页面切换：< 500ms
- 蓝牙连接：< 5秒
- 音频延迟：< 50ms

### 6.2 稳定性要求
- 崩溃率：< 0.1%
- ANR率：< 0.05%
- 内存占用：< 200MB

### 6.3 兼容性要求
- 设备适配：主流机型全覆盖
- 系统版本：覆盖95%以上用户
- 横竖屏：支持竖屏模式

## 七、安全与隐私

### 7.1 数据安全
- 传输加密：TLS 1.3
- 本地加密：敏感数据AES-256
- 认证机制：OAuth 2.0

### 7.2 隐私保护
- 最小权限原则
- 数据匿名化处理
- 用户数据可导出/删除
- 符合GDPR/CCPA规范

## 八、测试计划

### 8.1 测试范围
- 单元测试：核心功能覆盖率>80%
- 集成测试：主要流程全覆盖
- 兼容性测试：Top 20机型
- 性能测试：压力测试、稳定性测试

### 8.2 测试环境
- 真机测试：iOS/Android各5台
- 模拟器测试：全版本覆盖
- 蓝牙设备：多型号测试

## 九、项目排期

### 9.1 开发阶段划分

**Phase 1 (4周)：基础框架**
- 项目搭建
- 蓝牙通信模块
- 基础UI框架

**Phase 2 (6周)：核心功能**
- 设备控制功能
- 音频处理模块
- 基础交互界面

**Phase 3 (4周)：内容功能**
- 虚拟角色系统
- 剧情系统
- 音频导入功能

**Phase 4 (3周)：优化完善**
- 性能优化
- UI美化
- Bug修复

**Phase 5 (2周)：测试上线**
- 完整测试
- 发布准备
- 上线部署

### 9.2 里程碑
- M1：Demo版本（基础蓝牙控制）
- M2：Alpha版本（核心功能完成）
- M3：Beta版本（全功能集成）
- M4：Release版本（正式发布）

## 十、风险与对策

### 10.1 技术风险
- **蓝牙兼容性**：建立设备兼容性列表，持续更新
- **音频处理性能**：优化算法，必要时降级处理
- **Live2D渲染**：提供性能模式选项

### 10.2 合规风险
- **隐私政策**：法务审核，定期更新
- **内容审核**：建立内容审核机制
- **年龄限制**：实施年龄验证机制

## 十一、后续规划

### 11.1 版本迭代计划
- v1.1：社区功能
- v1.2：云端同步
- v2.0：AI个性化推荐

### 11.2 扩展功能
- 多语言支持
- 社交分享
- 虚拟角色定制
- 硬件产品扩展

## 附录

### A. 术语表
- BLE：Bluetooth Low Energy，低功耗蓝牙
- L2D：Live2D，2D动画技术
- FFT：Fast Fourier Transform，快速傅里叶变换

### B. 参考文档
- 蓝牙BLE开发规范
- iOS/Android开发指南
- 音频处理技术文档